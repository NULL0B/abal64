#ifndef	_vga_c
#define _vga_c

#include <stdio.h>
#include "palet.h"
#include "sysfile.h"

int vgapalette( char * pptr, int i, int j );

static	int	respect_colours=1;

static char	VgaPalette[256][4] = {
/* index   0 - 00 */ 0x00, 0x00, 0x00, 0x00,
/* index   1 - 01 */ 0x00, 0x00, 0x80, 0x00,
/* index   2 - 02 */ 0x00, 0x80, 0x00, 0x00,
/* index   3 - 03 */ 0x00, 0x80, 0x80, 0x00,
/* index   4 - 04 */ 0x80, 0x00, 0x00, 0x00,
/* index   5 - 05 */ 0x80, 0x00, 0x80, 0x00,
/* index   6 - 06 */ 0x80, 0x80, 0x00, 0x00,
/* index   7 - 07 */ 0x80, 0x80, 0x80, 0x00,
/* index   8 - 08 */ 0xC0, 0xC0, 0xC0, 0x00,
/* index   9 - 09 */ 0x00, 0x00, 0xFF, 0x00,
/* index  10 - 0A */ 0x00, 0xFF, 0x00, 0x00,
/* index  11 - 0B */ 0x00, 0xFF, 0xFF, 0x00,
/* index  12 - 0C */ 0xFF, 0x00, 0x00, 0x00,
/* index  13 - 0D */ 0xFF, 0x00, 0xFF, 0x00,
/* index  14 - 0E */ 0xFF, 0xFF, 0x00, 0x00,
/* index  15 - 0F */ 0xFF, 0xFF, 0xFF, 0x00,
/* index  16 - 10 */ 0x01, 0x01, 0x01, 0x00,
/* index  17 - 11 */ 0x64, 0x64, 0x64, 0x00,
/* index  18 - 12 */ 0x82, 0x82, 0x82, 0x00,
/* index  19 - 13 */ 0x94, 0x94, 0x94, 0x00,
/* index  20 - 14 */ 0xAA, 0xAA, 0xAA, 0x00,
/* index  21 - 15 */ 0xC1, 0xC1, 0xC1, 0x00,
/* index  22 - 16 */ 0xD7, 0xD7, 0xD7, 0x00,
/* index  23 - 17 */ 0xF0, 0xF0, 0xF0, 0x00,
/* index  24 - 18 */ 0xFE, 0xFE, 0xFE, 0x00,
/* index  25 - 19 */ 0x00, 0xFE, 0xFF, 0x00,
/* index  26 - 1A */ 0x00, 0x40, 0xFF, 0x00,
/* index  27 - 1B */ 0x01, 0x01, 0x80, 0x00,
/* index  28 - 1C */ 0xFF, 0xFF, 0xC4, 0x00,
/* index  29 - 1D */ 0x00, 0x80, 0xFF, 0x00,
/* index  30 - 1E */ 0xFF, 0xFF, 0xFF, 0x00,
/* index  31 - 1F */ 0xFF, 0xFF, 0xFF, 0x00,
/* index  32 - 20 */ 0x00, 0x00, 0x00, 0x00,
/* index  33 - 21 */ 0x00, 0x00, 0x33, 0x00,
/* index  34 - 22 */ 0x00, 0x00, 0x66, 0x00,
/* index  35 - 23 */ 0x00, 0x00, 0x99, 0x00,
/* index  36 - 24 */ 0x00, 0x00, 0xCC, 0x00,
/* index  37 - 25 */ 0x00, 0x00, 0xFF, 0x00,
/* index  38 - 26 */ 0x00, 0x33, 0x00, 0x00,
/* index  39 - 27 */ 0x00, 0x33, 0x33, 0x00,
/* index  40 - 28 */ 0x00, 0x33, 0x66, 0x00,
/* index  41 - 29 */ 0x00, 0x33, 0x99, 0x00,
/* index  42 - 2A */ 0x00, 0x33, 0xCC, 0x00,
/* index  43 - 2B */ 0x00, 0x33, 0xFF, 0x00,
/* index  44 - 2C */ 0x00, 0x66, 0x00, 0x00,
/* index  45 - 2D */ 0x00, 0x66, 0x33, 0x00,
/* index  46 - 2E */ 0x00, 0x66, 0x66, 0x00,
/* index  47 - 2F */ 0x00, 0x66, 0x99, 0x00,
/* index  48 - 30 */ 0x00, 0x66, 0xCC, 0x00,
/* index  49 - 31 */ 0x00, 0x66, 0xFF, 0x00,
/* index  50 - 32 */ 0x00, 0x99, 0x00, 0x00,
/* index  51 - 33 */ 0x00, 0x99, 0x33, 0x00,
/* index  52 - 34 */ 0x00, 0x99, 0x66, 0x00,
/* index  53 - 35 */ 0x00, 0x99, 0x99, 0x00,
/* index  54 - 36 */ 0x00, 0x99, 0xCC, 0x00,
/* index  55 - 37 */ 0x00, 0x99, 0xFF, 0x00,
/* index  56 - 38 */ 0x00, 0xCC, 0x00, 0x00,
/* index  57 - 39 */ 0x00, 0xCC, 0x33, 0x00,
/* index  58 - 3A */ 0x00, 0xCC, 0x66, 0x00,
/* index  59 - 3B */ 0x00, 0xCC, 0x99, 0x00,
/* index  60 - 3C */ 0x00, 0xCC, 0xCC, 0x00,
/* index  61 - 3D */ 0x00, 0xCC, 0xFF, 0x00,
/* index  62 - 3E */ 0x00, 0xFF, 0x00, 0x00,
/* index  63 - 3F */ 0x00, 0xFF, 0x33, 0x00,
/* index  64 - 40 */ 0x00, 0xFF, 0x66, 0x00,
/* index  65 - 41 */ 0x00, 0xFF, 0x99, 0x00,
/* index  66 - 42 */ 0x00, 0xFF, 0xCC, 0x00,
/* index  67 - 43 */ 0x00, 0xFF, 0xFF, 0x00,
/* index  68 - 44 */ 0x33, 0x00, 0x00, 0x00,
/* index  69 - 45 */ 0x33, 0x00, 0x33, 0x00,
/* index  70 - 46 */ 0x33, 0x00, 0x66, 0x00,
/* index  71 - 47 */ 0x33, 0x00, 0x99, 0x00,
/* index  72 - 48 */ 0x33, 0x00, 0xCC, 0x00,
/* index  73 - 49 */ 0x33, 0x00, 0xFF, 0x00,
/* index  74 - 4A */ 0x33, 0x33, 0x00, 0x00,
/* index  75 - 4B */ 0x33, 0x33, 0x33, 0x00,
/* index  76 - 4C */ 0x33, 0x33, 0x66, 0x00,
/* index  77 - 4D */ 0x33, 0x33, 0x99, 0x00,
/* index  78 - 4E */ 0x33, 0x33, 0xCC, 0x00,
/* index  79 - 4F */ 0x33, 0x33, 0xFF, 0x00,
/* index  80 - 50 */ 0x33, 0x66, 0x00, 0x00,
/* index  81 - 51 */ 0x33, 0x66, 0x33, 0x00,
/* index  82 - 52 */ 0x33, 0x66, 0x66, 0x00,
/* index  83 - 53 */ 0x33, 0x66, 0x99, 0x00,
/* index  84 - 54 */ 0x33, 0x66, 0xCC, 0x00,
/* index  85 - 55 */ 0x33, 0x66, 0xFF, 0x00,
/* index  86 - 56 */ 0x33, 0x99, 0x00, 0x00,
/* index  87 - 57 */ 0x33, 0x99, 0x33, 0x00,
/* index  88 - 58 */ 0x33, 0x99, 0x66, 0x00,
/* index  89 - 59 */ 0x33, 0x99, 0x99, 0x00,
/* index  90 - 5A */ 0x33, 0x99, 0xCC, 0x00,
/* index  91 - 5B */ 0x33, 0x99, 0xFF, 0x00,
/* index  92 - 5C */ 0x33, 0xCC, 0x00, 0x00,
/* index  93 - 5D */ 0x33, 0xCC, 0x33, 0x00,
/* index  94 - 5E */ 0x33, 0xCC, 0x66, 0x00,
/* index  95 - 5F */ 0x33, 0xCC, 0x99, 0x00,
/* index  96 - 60 */ 0x33, 0xCC, 0xCC, 0x00,
/* index  97 - 61 */ 0x33, 0xCC, 0xFF, 0x00,
/* index  98 - 62 */ 0x33, 0xFF, 0x00, 0x00,
/* index  99 - 63 */ 0x33, 0xFF, 0x33, 0x00,
/* index 100 - 64 */ 0x33, 0xFF, 0x66, 0x00,
/* index 101 - 65 */ 0x33, 0xFF, 0x99, 0x00,
/* index 102 - 66 */ 0x33, 0xFF, 0xCC, 0x00,
/* index 103 - 67 */ 0x33, 0xFF, 0xFF, 0x00,
/* index 104 - 68 */ 0x66, 0x00, 0x00, 0x00,
/* index 105 - 69 */ 0x66, 0x00, 0x33, 0x00,
/* index 106 - 6A */ 0x66, 0x00, 0x66, 0x00,
/* index 107 - 6B */ 0x66, 0x00, 0x99, 0x00,
/* index 108 - 6C */ 0x66, 0x00, 0xCC, 0x00,
/* index 109 - 6D */ 0x66, 0x00, 0xFF, 0x00,
/* index 110 - 6E */ 0x66, 0x33, 0x00, 0x00,
/* index 111 - 6F */ 0x66, 0x33, 0x33, 0x00,
/* index 112 - 70 */ 0x66, 0x33, 0x66, 0x00,
/* index 113 - 71 */ 0x66, 0x33, 0x99, 0x00,
/* index 114 - 72 */ 0x66, 0x33, 0xCC, 0x00,
/* index 115 - 73 */ 0x66, 0x33, 0xFF, 0x00,
/* index 116 - 74 */ 0x66, 0x66, 0x00, 0x00,
/* index 117 - 75 */ 0x66, 0x66, 0x33, 0x00,
/* index 118 - 76 */ 0x66, 0x66, 0x66, 0x00,
/* index 119 - 77 */ 0x66, 0x66, 0x99, 0x00,
/* index 120 - 78 */ 0x66, 0x66, 0xCC, 0x00,
/* index 121 - 79 */ 0x66, 0x66, 0xFF, 0x00,
/* index 122 - 7A */ 0x66, 0x99, 0x00, 0x00,
/* index 123 - 7B */ 0x66, 0x99, 0x33, 0x00,
/* index 124 - 7C */ 0x66, 0x99, 0x66, 0x00,
/* index 125 - 7D */ 0x66, 0x99, 0x99, 0x00,
/* index 126 - 7E */ 0x66, 0x99, 0xCC, 0x00,
/* index 127 - 7F */ 0x66, 0x99, 0xFF, 0x00,
/* index 128 - 80 */ 0x66, 0xCC, 0x00, 0x00,
/* index 129 - 81 */ 0x66, 0xCC, 0x33, 0x00,
/* index 130 - 82 */ 0x66, 0xCC, 0x66, 0x00,
/* index 131 - 83 */ 0x66, 0xCC, 0x99, 0x00,
/* index 132 - 84 */ 0x66, 0xCC, 0xCC, 0x00,
/* index 133 - 85 */ 0x66, 0xCC, 0xFF, 0x00,
/* index 134 - 86 */ 0x66, 0xFF, 0x00, 0x00,
/* index 135 - 87 */ 0x66, 0xFF, 0x33, 0x00,
/* index 136 - 88 */ 0x66, 0xFF, 0x66, 0x00,
/* index 137 - 89 */ 0x66, 0xFF, 0x99, 0x00,
/* index 138 - 8A */ 0x66, 0xFF, 0xCC, 0x00,
/* index 139 - 8B */ 0x66, 0xFF, 0xFF, 0x00,
/* index 140 - 8C */ 0x99, 0x00, 0x00, 0x00,
/* index 141 - 8D */ 0x99, 0x00, 0x33, 0x00,
/* index 142 - 8E */ 0x99, 0x00, 0x66, 0x00,
/* index 143 - 8F */ 0x99, 0x00, 0x99, 0x00,
/* index 144 - 90 */ 0x99, 0x00, 0xCC, 0x00,
/* index 145 - 91 */ 0x99, 0x00, 0xFF, 0x00,
/* index 146 - 92 */ 0x99, 0x33, 0x00, 0x00,
/* index 147 - 93 */ 0x99, 0x33, 0x33, 0x00,
/* index 148 - 94 */ 0x99, 0x33, 0x66, 0x00,
/* index 149 - 95 */ 0x99, 0x33, 0x99, 0x00,
/* index 150 - 96 */ 0x99, 0x33, 0xCC, 0x00,
/* index 151 - 97 */ 0x99, 0x33, 0xFF, 0x00,
/* index 152 - 98 */ 0x99, 0x66, 0x00, 0x00,
/* index 153 - 99 */ 0x99, 0x66, 0x33, 0x00,
/* index 154 - 9A */ 0x99, 0x66, 0x66, 0x00,
/* index 155 - 9B */ 0x99, 0x66, 0x99, 0x00,
/* index 156 - 9C */ 0x99, 0x66, 0xCC, 0x00,
/* index 157 - 9D */ 0x99, 0x66, 0xFF, 0x00,
/* index 158 - 9E */ 0x99, 0x99, 0x00, 0x00,
/* index 159 - 9F */ 0x99, 0x99, 0x33, 0x00,
/* index 160 - A0 */ 0x99, 0x99, 0x66, 0x00,
/* index 161 - A1 */ 0x99, 0x99, 0x99, 0x00,
/* index 162 - A2 */ 0x99, 0x99, 0xCC, 0x00,
/* index 163 - A3 */ 0x99, 0x99, 0xFF, 0x00,
/* index 164 - A4 */ 0x99, 0xCC, 0x00, 0x00,
/* index 165 - A5 */ 0x99, 0xCC, 0x33, 0x00,
/* index 166 - A6 */ 0x99, 0xCC, 0x66, 0x00,
/* index 167 - A7 */ 0x99, 0xCC, 0x99, 0x00,
/* index 168 - A8 */ 0x99, 0xCC, 0xCC, 0x00,
/* index 169 - A9 */ 0x99, 0xCC, 0xFF, 0x00,
/* index 170 - AA */ 0x99, 0xFF, 0x00, 0x00,
/* index 171 - AB */ 0x99, 0xFF, 0x33, 0x00,
/* index 172 - AC */ 0x99, 0xFF, 0x66, 0x00,
/* index 173 - AD */ 0x99, 0xFF, 0x99, 0x00,
/* index 174 - AE */ 0x99, 0xFF, 0xCC, 0x00,
/* index 175 - AF */ 0x99, 0xFF, 0xFF, 0x00,
/* index 176 - B0 */ 0xCC, 0x00, 0x00, 0x00,
/* index 177 - B1 */ 0xCC, 0x00, 0x33, 0x00,
/* index 178 - B2 */ 0xCC, 0x00, 0x66, 0x00,
/* index 179 - B3 */ 0xCC, 0x00, 0x99, 0x00,
/* index 180 - B4 */ 0xCC, 0x00, 0xCC, 0x00,
/* index 181 - B5 */ 0xCC, 0x00, 0xFF, 0x00,
/* index 182 - B6 */ 0xCC, 0x33, 0x00, 0x00,
/* index 183 - B7 */ 0xCC, 0x33, 0x33, 0x00,
/* index 184 - B8 */ 0xCC, 0x33, 0x66, 0x00,
/* index 185 - B9 */ 0xCC, 0x33, 0x99, 0x00,
/* index 186 - BA */ 0xCC, 0x33, 0xCC, 0x00,
/* index 187 - BB */ 0xCC, 0x33, 0xFF, 0x00,
/* index 188 - BC */ 0xCC, 0x66, 0x00, 0x00,
/* index 189 - BD */ 0xCC, 0x66, 0x33, 0x00,
/* index 190 - BE */ 0xCC, 0x66, 0x66, 0x00,
/* index 191 - BF */ 0xCC, 0x66, 0x99, 0x00,
/* index 192 - C0 */ 0xCC, 0x66, 0xCC, 0x00,
/* index 193 - C1 */ 0xCC, 0x66, 0xFF, 0x00,
/* index 194 - C2 */ 0xCC, 0x99, 0x00, 0x00,
/* index 195 - C3 */ 0xCC, 0x99, 0x33, 0x00,
/* index 196 - C4 */ 0xCC, 0x99, 0x66, 0x00,
/* index 197 - C5 */ 0xCC, 0x99, 0x99, 0x00,
/* index 198 - C6 */ 0xCC, 0x99, 0xCC, 0x00,
/* index 199 - C7 */ 0xCC, 0x99, 0xFF, 0x00,
/* index 200 - C8 */ 0xCC, 0xCC, 0x00, 0x00,
/* index 201 - C9 */ 0xCC, 0xCC, 0x33, 0x00,
/* index 202 - CA */ 0xCC, 0xCC, 0x66, 0x00,
/* index 203 - CB */ 0xCC, 0xCC, 0x99, 0x00,
/* index 204 - CC */ 0xCC, 0xCC, 0xCC, 0x00,
/* index 205 - CD */ 0xCC, 0xCC, 0xFF, 0x00,
/* index 206 - CE */ 0xCC, 0xFF, 0x00, 0x00,
/* index 207 - CF */ 0xCC, 0xFF, 0x33, 0x00,
/* index 208 - D0 */ 0xCC, 0xFF, 0x66, 0x00,
/* index 209 - D1 */ 0xCC, 0xFF, 0x99, 0x00,
/* index 210 - D2 */ 0xCC, 0xFF, 0xCC, 0x00,
/* index 211 - D3 */ 0xCC, 0xFF, 0xFF, 0x00,
/* index 212 - D4 */ 0xFF, 0x00, 0x00, 0x00,
/* index 213 - D5 */ 0xFF, 0x00, 0x33, 0x00,
/* index 214 - D6 */ 0xFF, 0x00, 0x66, 0x00,
/* index 215 - D7 */ 0xFF, 0x00, 0x99, 0x00,
/* index 216 - D8 */ 0xFF, 0x00, 0xCC, 0x00,
/* index 217 - D9 */ 0xFF, 0x00, 0xFF, 0x00,
/* index 218 - DA */ 0xFF, 0x33, 0x00, 0x00,
/* index 219 - DB */ 0xFF, 0x33, 0x33, 0x00,
/* index 220 - DC */ 0xFF, 0x33, 0x66, 0x00,
/* index 221 - DD */ 0xFF, 0x33, 0x99, 0x00,
/* index 222 - DE */ 0xFF, 0x33, 0xCC, 0x00,
/* index 223 - DF */ 0xFF, 0x33, 0xFF, 0x00,
/* index 224 - E0 */ 0xFF, 0x66, 0x00, 0x00,
/* index 225 - E1 */ 0xFF, 0x66, 0x33, 0x00,
/* index 226 - E2 */ 0xFF, 0x66, 0x66, 0x00,
/* index 227 - E3 */ 0xFF, 0x66, 0x99, 0x00,
/* index 228 - E4 */ 0xFF, 0x66, 0xCC, 0x00,
/* index 229 - E5 */ 0xFF, 0x66, 0xFF, 0x00,
/* index 230 - E6 */ 0xFF, 0x99, 0x00, 0x00,
/* index 231 - E7 */ 0xFF, 0x99, 0x33, 0x00,
/* index 232 - E8 */ 0xFF, 0x99, 0x66, 0x00,
/* index 233 - E9 */ 0xFF, 0x99, 0x99, 0x00,
/* index 234 - EA */ 0xFF, 0x99, 0xCC, 0x00,
/* index 235 - EB */ 0xFF, 0x99, 0xFF, 0x00,
/* index 236 - EC */ 0xFF, 0xCC, 0x00, 0x00,
/* index 237 - ED */ 0xFF, 0xCC, 0x33, 0x00,
/* index 238 - EE */ 0xFF, 0xCC, 0x66, 0x00,
/* index 239 - EF */ 0xFF, 0xCC, 0x99, 0x00,
/* index 240 - F0 */ 0xFF, 0xCC, 0xCC, 0x00,
/* index 241 - F1 */ 0xFF, 0xCC, 0xFF, 0x00,
/* index 242 - F2 */ 0xFF, 0xFF, 0x00, 0x00,
/* index 243 - F3 */ 0xFF, 0xFF, 0x33, 0x00,
/* index 244 - F4 */ 0xFF, 0xFF, 0x66, 0x00,
/* index 245 - F5 */ 0xFF, 0xFF, 0x99, 0x00,
/* index 246 - F6 */ 0xFF, 0xFF, 0xCC, 0x00,
/* index 247 - F7 */ 0xFF, 0xFF, 0xFF, 0x00,
/* index 248 - F8 */ 0x32, 0x32, 0x32, 0x00,
/* index 249 - F9 */ 0x65, 0x65, 0x65, 0x00,
/* index 250 - FA */ 0x83, 0x83, 0x83, 0x00,
/* index 251 - FB */ 0x95, 0x95, 0x95, 0x00,
/* index 252 - FC */ 0xAB, 0xAB, 0xAB, 0x00,
/* index 253 - FD */ 0xC2, 0xC2, 0xC2, 0x00,
/* index 254 - FE */ 0xD8, 0xD8, 0xD8, 0x00,
/* index 255 - FF */ 0xE7, 0xE7, 0xE7, 0x00,
	};

char 			* thispalette=(char *) VgaPalette;

int	rgb_to_ycrcb( int v )
{
	int	r=0;
	int	g=0;
	int	b=0;
	char *  pptr;
	if (( v >= 0 ) && ( v <= 255)) {
		pptr = (thispalette + (v*4));
		if ((r = (*(pptr + 3) & 0x00FF)) != 0)
			return(r);
		else 	{
			r = (*pptr & 0x00FF);
			g = (*(pptr+1) & 0x00FF);
			b = (*(pptr+2) & 0x00FF);
			return((*(pptr+3) = (((r*54)+(g*183)+(b*19))/256)));
			}
		}
	else	return( 0 );
}

int	rgb_to_grey( int v )
{
	int	r;
	int	i;
	int	d=256;
	int	di=0;
	int	n;
	char *	pptr;

	v =rgb_to_ycrcb(v);

	for ( i=0x00F8; i < 256; i++ ) {
		pptr = (thispalette+(i*4));
		if ((r = *pptr) == v)
			return(i);	
		else if ( v > r ) 
			n = (v - r);
		else	n = (r - v);
		if (( d == 256 ) ||  ( n < d )) {
			d = n;
			di = i;
			}
		}
	return( di );
	
}

#define	_RED_WEIGHT	54	/* 299 : PS : GIF */
#define	_GREEN_WEIGHT	183	/* 587 : PS : GIF */
#define	_BLUE_WEIGHT	19	/* 114 : PS : GIF */

int	vga_luminence( int r, int g, int b )
{
	int	l;
	l = (((r*_RED_WEIGHT)+(g*_GREEN_WEIGHT)+(b*_BLUE_WEIGHT))/256);
	return(l);
}

int	vga_approximation(int  r, int  g, int  b )
{
	int	nr=255,ng=255,nb=255,ni=0;
	int	dr,dg,db,dt;
	int	pr,pg,pb;
	int	nt=255+255+255;
	char * pptr;
	char * qptr;
	short	i;
	int	l;
	int	ll;

	// -----------------------
	//  Locate nearest colour
	// -----------------------
	l = vga_luminence( r,g,b );

/*	printf("vga_approximation( r=%u, g=%u, b=%u, l=%u )\r\n",r,g,b,l);	*/

	for ( qptr=pptr=thispalette, nt=255+255+255, ni=0, i = 0; i < 256; i++ ) {

		// ----------------------
		// Collect Palette Values
		// ----------------------
		pr = (*(pptr++) & 0x00FF);
		pg = (*(pptr++) & 0x00FF);
		pb = (*(pptr++) & 0x00FF);

		pptr++;

		// -----------------------------
		// Detect Exact Match and Return
		// -----------------------------
		if ((pr == r) &&  (pg == g) &&  (pb == b)) {
			/* printf("vga_approximation( r=%u, g=%u, b=%u : %u exact match )\r\n",r,g,b,ni,pr,pg,pb); */
			return(i);
			}

		// -----------------------------
		// Calculate Total Differentiel
		// -----------------------------
		if (pr > r) dr = pr-r; else dr = r-pr;
		if (pg > g) dg = pg-g; else dg = g-pg;
		if (pb > b) db = pb-b; else db = b-pb;

		if(( dr < nr ) 
		&& ( dg < ng ) 
		&& ( db < nb )){

			ni = i;
			nr = dr;
			ng = dg;
			nb = db;
			printf("        partial  ( r=%u, g=%u, b=%u : %u ( r=%u, g=%u, b=%u ) )\r\n",r,g,b,ni,pr,pg,pb);
			}
		}

#ifdef	DEBUG_APPROXIMATION
	pptr = (thispalette + (ni * 4));
		pr = (*(pptr++) & 0x00FF);
		pg = (*(pptr++) & 0x00FF);
		pb = (*(pptr++) & 0x00FF);

	
	ll = vga_luminence( pr,pg,pb );
	printf("old_vga_approximation( r=%u, g=%u, b=%u l=%u : %u ( r=%u, g=%u, b=%u, l=%u ) )\r\n",r,g,b,l,ni,pr,pg,pb,ll);
#endif
	return( ni );
}

int 	load_palette( char * filename )
{
	int		i,v;
	FILE *		handle;
	if ((handle = fopen(sysfilename( filename ), "rb" )) != (FILE *) 0) {
		fread( thispalette, 256 * 4, 1, handle);
		fclose( handle );
		vgapalette(thispalette, 0,256);
		return(0);
		}
	else	return(40);

}

void	get_rgb_values(int entry, int * rvalue, int * gvalue, int * bvalue )
{
	if ( entry < 256 ) {
		*rvalue = ( *(thispalette+(entry*4)) & 0x00FF );
		*gvalue = ( *(thispalette+(entry*4)+1) & 0x00FF );
		*bvalue = ( *(thispalette+(entry*4)+1) & 0x00FF );
		}
	else	{
		*rvalue = 0;
		*gvalue = 0;
		*bvalue = 0;
		}
	return;
}

void	put_palette()
{
	vgapalette((char *) thispalette,0, 256 );
	return;
}

char *	get_vga_palette()
{
	return( thispalette );
}

#endif	// _zvga_c

