// 	------------------------------------------------------------------
//	Project		Web Navigator/Browser	for Amenesik / Sologic / Twin Server
//	------------------------------------------------------------------
#ifndef	_colour_c
#define _colour_c

#include <stdio.h>
#include "pixel.h"
#include "vncmem.h"

static	int	InitialisedColours=0;
unsigned char * VgaPointers[128];

unsigned char	VgaBgr233[256];

unsigned short	VgaBgr555[256];

unsigned char	VgaColours[256][4] = {

	0, 0, 0, 0, 		0, 0, 128, 0, 	 
	0, 128, 0, 0, 	 	0, 128, 128, 0, 
	128, 0, 0, 0, 		128, 0, 128, 0,  
	128, 128, 0, 0, 	128, 128, 128, 0, 
	192, 192, 192, 0,	0, 0, 255, 0, 
	0, 255, 0, 0, 		0, 255, 255, 0, 
	255, 0, 0, 0, 		255, 0, 255, 0, 
	255, 255, 0, 0, 	255, 255, 255, 0, 

	0x0006,	0x0006,	0x0006,	0x0000,
	0x0014,	0x0014,	0x0014,	0x0000,
	0x0020,	0x0020,	0x0020,	0x0000,
	0x002C,	0x002C,	0x002C,	0x0000,

	0x0038,	0x0038,	0x0038,	0x0000,
	0x0044,	0x0044,	0x0044,	0x0000,
	0x0050,	0x0050,	0x0050,	0x0000,
	0x0061,	0x0061,	0x0061,	0x0000,

	0x0071,	0x0071,	0x0071,	0x0000,
	0x0081,	0x0081,	0x0081,	0x0000,
	0x0091,	0x0091,	0x0091,	0x0000,
	0x00A1,	0x00A1,	0x00A1,	0x0000,

	0x00B6,	0x00B6,	0x00B6,	0x0000,
	0x00CA,	0x00CA,	0x00CA,	0x0000,
	0x00E2,	0x00E2,	0x00E2,	0x0000,
	0x00FF,	0x00FF,	0x00FF,	0x0000,

	0x0000,	0x0000,	0x00FF,	0x0000,
	0x0040,	0x0000,	0x00FF,	0x0000,
	0x007D,	0x0000,	0x00FF,	0x0000,
	0x00BE,	0x0000,	0x00FF,	0x0000,

	0x00FF,	0x0000,	0x00FF,	0x0000,
	0x00FF,	0x0000,	0x00BE,	0x0000,
	0x00FF,	0x0000,	0x007D,	0x0000,
	0x00FF,	0x0000,	0x0040,	0x0000,

	0x00FF,	0x0000,	0x0000,	0x0000,
	0x00FF,	0x0040,	0x0000,	0x0000,
	0x00FF,	0x007D,	0x0000,	0x0000,
	0x00FF,	0x00BE,	0x0000,	0x0000,

	0x00FF,	0x00FF,	0x0000,	0x0000,
	0x00BE,	0x00FF,	0x0000,	0x0000,
	0x007D,	0x00FF,	0x0000,	0x0000,
	0x0040,	0x00FF,	0x0000,	0x0000,

	0x0000,	0x00FF,	0x0000,	0x0000,
	0x0000,	0x00FF,	0x0040,	0x0000,
	0x0000,	0x00FF,	0x007D,	0x0000,
	0x0000,	0x00FF,	0x00BE,	0x0000,

	0x0000,	0x00FF,	0x00FF,	0x0000,
	0x0000,	0x00BE,	0x00FF,	0x0000,
	0x0000,	0x007D,	0x00FF,	0x0000,
	0x0000,	0x0040,	0x00FF,	0x0000,

	0x007D,	0x007D,	0x00FF,	0x0000,
	0x009D,	0x007D,	0x00FF,	0x0000,
	0x00BE,	0x007D,	0x00FF,	0x0000,
	0x00DE,	0x007D,	0x00FF,	0x0000,

	0x00FF,	0x007D,	0x00FF,	0x0000,
	0x00FF,	0x007D,	0x00DE,	0x0000,
	0x00FF,	0x007D,	0x00BE,	0x0000,
	0x00FF,	0x007D,	0x009D,	0x0000,

	0x00FF,	0x007D,	0x007D,	0x0000,
	0x00FF,	0x009D,	0x007D,	0x0000,
	0x00FF,	0x00BE,	0x007D,	0x0000,
	0x00FF,	0x00DE,	0x007D,	0x0000,

	0x00FF,	0x00FF,	0x007D,	0x0000,
	0x00DE,	0x00FF,	0x007D,	0x0000,
	0x00BE,	0x00FF,	0x007D,	0x0000,
	0x009D,	0x00FF,	0x007D,	0x0000,

	0x007D,	0x00FF,	0x007D,	0x0000,
	0x007D,	0x00FF,	0x009D,	0x0000,
	0x007D,	0x00FF,	0x00BE,	0x0000,
	0x007D,	0x00FF,	0x00DE,	0x0000,

	0x007D,	0x00FF,	0x00FF,	0x0000,
	0x007D,	0x00DE,	0x00FF,	0x0000,
	0x007D,	0x00BE,	0x00FF,	0x0000,
	0x007D,	0x009D,	0x00FF,	0x0000,

	0x00B6,	0x00B6,	0x00FF,	0x0000,
	0x00C6,	0x00B6,	0x00FF,	0x0000,
	0x00DA,	0x00B6,	0x00FF,	0x0000,
	0x00EA,	0x00B6,	0x00FF,	0x0000,

	0x00FF,	0x00B6,	0x00FF,	0x0000,
	0x00FF,	0x00B6,	0x00EA,	0x0000,
	0x00FF,	0x00B6,	0x00DA,	0x0000,
	0x00FF,	0x00B6,	0x00C6,	0x0000,

	0x00FF,	0x00B6,	0x00B6,	0x0000,
	0x00FF,	0x00C6,	0x00B6,	0x0000,
	0x00FF,	0x00DA,	0x00B6,	0x0000,
	0x00FF,	0x00EA,	0x00B6,	0x0000,

	0x00FF,	0x00FF,	0x00B6,	0x0000,
	0x00EA,	0x00FF,	0x00B6,	0x0000,
	0x00DA,	0x00FF,	0x00B6,	0x0000,
	0x00C6,	0x00FF,	0x00B6,	0x0000,

	0x00B6,	0x00FF,	0x00B6,	0x0000,
	0x00B6,	0x00FF,	0x00C6,	0x0000,
	0x00B6,	0x00FF,	0x00DA,	0x0000,
	0x00B6,	0x00FF,	0x00EA,	0x0000,

	0x00B6,	0x00FF,	0x00FF,	0x0000,
	0x00B6,	0x00EA,	0x00FF,	0x0000,
	0x00B6,	0x00DA,	0x00FF,	0x0000,
	0x00B6,	0x00C6,	0x00FF,	0x0000,

	0x0000,	0x0000,	0x0071,	0x0000,
	0x001C,	0x0000,	0x0071,	0x0000,
	0x0038,	0x0000,	0x0071,	0x0000,
	0x0055,	0x0000,	0x0071,	0x0000,

	0x0071,	0x0000,	0x0071,	0x0000,
	0x0071,	0x0000,	0x0055,	0x0000,
	0x0071,	0x0000,	0x0038,	0x0000,
	0x0071,	0x0000,	0x001C,	0x0000,

	0x0071,	0x0000,	0x0000,	0x0000,
	0x0071,	0x001C,	0x0000,	0x0000,
	0x0071,	0x0038,	0x0000,	0x0000,
	0x0071,	0x0055,	0x0000,	0x0000,

	0x0071,	0x0071,	0x0000,	0x0000,
	0x0055,	0x0071,	0x0000,	0x0000,
	0x0038,	0x0071,	0x0000,	0x0000,
	0x001C,	0x0071,	0x0000,	0x0000,

	0x0000,	0x0071,	0x0000,	0x0000,
	0x0000,	0x0071,	0x001C,	0x0000,
	0x0000,	0x0071,	0x0038,	0x0000,
	0x0000,	0x0071,	0x0055,	0x0000,

	0x0000,	0x0071,	0x0071,	0x0000,
	0x0000,	0x0055,	0x0071,	0x0000,
	0x0000,	0x0038,	0x0071,	0x0000,
	0x0000,	0x001C,	0x0071,	0x0000,

	0x0038,	0x0038,	0x0071,	0x0000,
	0x0044,	0x0038,	0x0071,	0x0000,
	0x0055,	0x0038,	0x0071,	0x0000,
	0x0061,	0x0038,	0x0071,	0x0000,

	0x0071,	0x0038,	0x0071,	0x0000,
	0x0071,	0x0038,	0x0061,	0x0000,
	0x0071,	0x0038,	0x0055,	0x0000,
	0x0071,	0x0038,	0x0044,	0x0000,

	0x0071,	0x0038,	0x0038,	0x0000,
	0x0071,	0x0044,	0x0038,	0x0000,
	0x0071,	0x0055,	0x0038,	0x0000,
	0x0071,	0x0061,	0x0038,	0x0000,

	0x0071,	0x0071,	0x0038,	0x0000,
	0x0061,	0x0071,	0x0038,	0x0000,
	0x0055,	0x0071,	0x0038,	0x0000,
	0x0044,	0x0071,	0x0038,	0x0000,

	0x0038,	0x0071,	0x0038,	0x0000,
	0x0038,	0x0071,	0x0044,	0x0000,
	0x0038,	0x0071,	0x0055,	0x0000,
	0x0038,	0x0071,	0x0061,	0x0000,

	0x0038,	0x0071,	0x0071,	0x0000,
	0x0038,	0x0061,	0x0071,	0x0000,
	0x0038,	0x0055,	0x0071,	0x0000,
	0x0038,	0x0044,	0x0071,	0x0000,

	0x0050,	0x0050,	0x0071,	0x0000,
	0x0059,	0x0050,	0x0071,	0x0000,
	0x0061,	0x0050,	0x0071,	0x0000,
	0x0069,	0x0050,	0x0071,	0x0000,

	0x0071,	0x0050,	0x0071,	0x0000,
	0x0071,	0x0050,	0x0069,	0x0000,
	0x0071,	0x0050,	0x0061,	0x0000,
	0x0071,	0x0050,	0x0059,	0x0000,

	0x0071,	0x0050,	0x0050,	0x0000,
	0x0071,	0x0059,	0x0050,	0x0000,
	0x0071,	0x0061,	0x0050,	0x0000,
	0x0071,	0x0069,	0x0050,	0x0000,

	0x0071,	0x0071,	0x0050,	0x0000,
	0x0069,	0x0071,	0x0050,	0x0000,
	0x0061,	0x0071,	0x0050,	0x0000,
	0x0059,	0x0071,	0x0050,	0x0000,

	0x0050,	0x0071,	0x0050,	0x0000,
	0x0050,	0x0071,	0x0059,	0x0000,
	0x0050,	0x0071,	0x0061,	0x0000,
	0x0050,	0x0071,	0x0069,	0x0000,

	0x0050,	0x0071,	0x0071,	0x0000,
	0x0050,	0x0069,	0x0071,	0x0000,
	0x0050,	0x0061,	0x0071,	0x0000,
	0x0050,	0x0059,	0x0071,	0x0000,

	0x0000,	0x0000,	0x0040,	0x0000,
	0x0010,	0x0000,	0x0040,	0x0000,
	0x0020,	0x0000,	0x0040,	0x0000,
	0x0030,	0x0000,	0x0040,	0x0000,

	0x0040,	0x0000,	0x0040,	0x0000,
	0x0040,	0x0000,	0x0030,	0x0000,
	0x0040,	0x0000,	0x0020,	0x0000,
	0x0040,	0x0000,	0x0010,	0x0000,

	0x0040,	0x0000,	0x0000,	0x0000,
	0x0040,	0x0010,	0x0000,	0x0000,
	0x0040,	0x0020,	0x0000,	0x0000,
	0x0040,	0x0030,	0x0000,	0x0000,

	0x0040,	0x0040,	0x0000,	0x0000,
	0x0030,	0x0040,	0x0000,	0x0000,
	0x0020,	0x0040,	0x0000,	0x0000,
	0x0010,	0x0040,	0x0000,	0x0000,

	0x0000,	0x0040,	0x0000,	0x0000,
	0x0000,	0x0040,	0x0010,	0x0000,
	0x0000,	0x0040,	0x0020,	0x0000,
	0x0000,	0x0040,	0x0030,	0x0000,

	0x0000,	0x0040,	0x0040,	0x0000,
	0x0000,	0x0030,	0x0040,	0x0000,
	0x0000,	0x0020,	0x0040,	0x0000,
	0x0000,	0x0010,	0x0040,	0x0000,

	0x0020,	0x0020,	0x0040,	0x0000,
	0x0028,	0x0020,	0x0040,	0x0000,
	0x0030,	0x0020,	0x0040,	0x0000,
	0x0038,	0x0020,	0x0040,	0x0000,

	0x0040,	0x0020,	0x0040,	0x0000,
	0x0040,	0x0020,	0x0038,	0x0000,
	0x0040,	0x0020,	0x0030,	0x0000,
	0x0040,	0x0020,	0x0028,	0x0000,

	0x0040,	0x0020,	0x0020,	0x0000,
	0x0040,	0x0028,	0x0020,	0x0000,
	0x0040,	0x0030,	0x0020,	0x0000,
	0x0040,	0x0038,	0x0020,	0x0000,

	0x0040,	0x0040,	0x0020,	0x0000,
	0x0038,	0x0040,	0x0020,	0x0000,
	0x0030,	0x0040,	0x0020,	0x0000,
	0x0028,	0x0040,	0x0020,	0x0000,

	0x0020,	0x0040,	0x0020,	0x0000,
	0x0020,	0x0040,	0x0028,	0x0000,
	0x0020,	0x0040,	0x0030,	0x0000,
	0x0020,	0x0040,	0x0038,	0x0000,

	0x0020,	0x0040,	0x0040,	0x0000,
	0x0020,	0x0038,	0x0040,	0x0000,
	0x0020,	0x0030,	0x0040,	0x0000,
	0x0020,	0x0028,	0x0040,	0x0000,

	0x002C,	0x002C,	0x0040,	0x0000,
	0x0030,	0x002C,	0x0040,	0x0000,
	0x0034,	0x002C,	0x0040,	0x0000,
	0x003C,	0x002C,	0x0040,	0x0000,

	0x0040,	0x002C,	0x0040,	0x0000,
	0x0040,	0x002C,	0x003C,	0x0000,
	0x0040,	0x002C,	0x0034,	0x0000,
	0x0040,	0x002C,	0x0030,	0x0000,

	0x0040,	0x002C,	0x002C,	0x0000,
	0x0040,	0x0030,	0x002C,	0x0000,
	0x0040,	0x0034,	0x002C,	0x0000,
	0x0040,	0x003C,	0x002C,	0x0000,

	0x0040,	0x0040,	0x002C,	0x0000,
	0x003C,	0x0040,	0x002C,	0x0000,
	0x0034,	0x0040,	0x002C,	0x0000,
	0x0030,	0x0040,	0x002C,	0x0000,

	0x002C,	0x0040,	0x002C,	0x0000,
	0x002C,	0x0040,	0x0030,	0x0000,
	0x002C,	0x0040,	0x0034,	0x0000,
	0x002C,	0x0040,	0x003C,	0x0000,

	0x002C,	0x0040,	0x0040,	0x0000,
	0x002C,	0x003C,	0x0040,	0x0000,
	0x002C,	0x0034,	0x0040,	0x0000,
	0x002C,	0x0030,	0x0040,	0x0000,

	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000,

	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000,
	0x0000,	0x0000,	0x0000,	0x0000

	};

void	activate_palette()
{
	vgapalette((char *) & VgaColours, 0, 256 );
	return;
}

int	calculate_server_conversion()
{
	int	r;
	int	g;
	int	b;
	int	i;
	int	v;
	for ( i=0; i < 255; i++ ) {
		r = ( VgaColours[i][0] & 0x00FF);
		g = ( VgaColours[i][1] & 0x00FF);
		b = ( VgaColours[i][2] & 0x00FF);
		v = ((( r & 0x00E0 ) >> 5) | (( g & 0x00E0 ) >> 2) | ( b & 0x00C0 ));
		VgaBgr233[i] = (v & 0x00FF);
		v = ((( r & 0x00F8 ) >> 3) | (( g & 0x00F8 ) << 2) | (( b & 0x00F8) << 7) );
		VgaBgr555[i] = v;
		}
	return;
}


int 	save_palette( char * filename )
{
	int		i,v;
	FILE *		handle;

	if ((handle = fopen( filename, "wb" )) != (FILE *) 0) {
		fwrite( VgaColours, 256 * 4, 1, handle);
		fclose( handle );
		}
	return;
}

int 	load_palette( char * filename )
{
	int		i,v;
	FILE *		handle;
	if ((handle = fopen( filename, "rb" )) != (FILE *) 0) {
		fread( VgaColours, 256 * 4, 1, handle);
		fclose( handle );
		return(0);
		}
	else	return(40);
}

int 	load_indirection( char * filename )
{
	int		i,v;
	FILE *		handle;
	unsigned char *		cptr;
	if ((handle = fopen( filename, "rb" )) != (FILE *) 0) {
		for ( i=0; i < 128; i++ ) {
			if ((cptr = malloc(256)) != 0) {
				fread( cptr, 256 , 1, handle);
				VgaPointers[i] = cptr;
				}
			else	break;
			}
		fclose( handle );
		return(0);
		}
	else	return(40);
}

int 	save_indirection( char * filename )
{
	int		i,v;
	FILE *		handle;
	unsigned char *		cptr;
	if ((handle = fopen( filename, "wb" )) != (FILE *) 0) {
		for ( i=0; i < 128; i++ ) {
			if ((cptr = VgaPointers[i]) != 0)
				fwrite( cptr, 256 , 1, handle);
			else	break;
			}
		fclose( handle );
		return(0);
		}
	else	return(40);
}

unsigned int	vga_approximation(unsigned int  r, unsigned int  g, unsigned int  b )
{
	int	nr,ng,nb,ni;
	int	dr,dg,db,dt;
	int	pr,pg,pb;
	int	nt=255+255+255;
	short	i;

	// Detect a shade of Grey 
	// ----------------------
	if ((r == g)
	&&  (g == b)) {
		if (!(r)) return(r);
		for ( ni= 16; ni < 32; ni++ )
			if ( (VgaColours[ni][0] & 0x00FF) >= r)
				break;
		}
	else	{
		// Locate nearest colour
		// ---------------------
		for ( nt=255+255+255, ni=0, i = 0; i < 256; i++ ) {

			// Collect Palette Values
			// ----------------------
			pr = ( VgaColours[i][0] & 0x00FF);
			pg = ( VgaColours[i][1] & 0x00FF);
			pb = ( VgaColours[i][2] & 0x00FF);

			// Detect Exact Match and Return
			// -----------------------------
			if ((pr == r) &&  (pg == g) &&  (pb == b))
				return(i);

			// Calculate Total Differentiel
			if (pr > r) dr = pr-r; else dr = r-pr;
			if (pg > g) dg = pg-g; else dg = g-pg;
			if (pb > b) db = pb-b; else db = b-pb;
			dt = dr+dg+db;
			if ( dt < nt ) {
				ni = i;
				nt = dt;
				}
			}
		}
	return( ni );
}


unsigned int	resolve_colour( unsigned int dath )
{
	unsigned int	rvalue;
	unsigned int	gvalue;
	unsigned int	bvalue;
	rvalue = (((dath & 0x001F) * 255) / 31);
	gvalue = ((((dath & 0x03E0)>>5) * 255) / 31);
	bvalue = ((((dath & 0x7C00)>>10) * 255) / 31);
	return( vga_approximation( rvalue, gvalue, bvalue ) );
}


void	calculate_bgr233()
{
	int	r;
	int	g;
	int	b;
	int	i;
	for ( i=0; i < 255; i++ ) {

		if (!(b = ((i & 0x00C0) >> 6)))
			VgaColours[i][2] = 0;
		else	VgaColours[i][2] = ((b * 255) / 3);
		if (!(g = ((i & 0x0038) >> 3)))
			VgaColours[i][1] = 0;
		else	VgaColours[i][1] = ((g * 255) / 7);
		if (!(r = (i & 0x0007) ))
			VgaColours[i][0] = 0;
		else	VgaColours[i][0] = ((r * 255) / 7);
			

		}
	return;
}

void	liberate_colours()
{
	int	i;
	unsigned char  * cptr;
	switch ( InitialisedColours ) {
		case	16	:
			for ( i=0; i < 128; i++ )
				if ((cptr = VgaPointers[i]) != 0)
					free( cptr );
			break;
		case	 8	:
			break;
		
		}
	InitialisedColours = 0;
	return;
}

void	initialise_colours(int colours)
{
	unsigned char  * cptr;
	int	i;
	int	j;
	int	v;

	if ( colours == InitialisedColours )
		return;

	else	liberate_colours();

	switch ((InitialisedColours = colours)) {

		case	16	:

			(void) load_palette( "bgr555.rgb" );

			for ( i=0; i < 128; i++ )
				VgaPointers[i] = 0;
								
			pixel_format_bgr555_16();

			if ( load_indirection("bgr555.bgr") != 0 ) {

				printf("building BGR 555 palette indirection table\n");
				for ( i=0; i < 128; i++ ) {
					printf("\r%u of %u",i+1,128);
					if (!(cptr = malloc(256))) {
						liberate_colours();
						return;										
						}	
					VgaPointers[i] = cptr;		
					for ( j=0; j < 256; j++ )
						*(cptr+j) = (unsigned char) resolve_colour(((i << 8) | j));

					}
				printf("\nsaving BGR 555 palette indirection table to disk\n");
				(void) save_indirection("bgr555.bgr");
				printf("BGR 555 palette indirection table ready\n");
				}

			break;

		case	 8	:
		default		:
			if ( load_palette( "bgr233.rgb" ) != 0 ) {
				calculate_bgr233();
				(void) save_palette("bgr233.rgb");
				}

			pixel_format_bgr233_8();
			break;
		}
	
	return;
}

#endif	// _colour_c











